apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: app-db
  namespace: database
spec:
  instances: 3
  imageName: ghcr.io/tensorchord/cloudnative-pgvecto.rs:14.11-v0.2.0@sha256:5fa56b8459e6d1cc8a4aeda22850eb05ac1d5cf410219eab3ceac0b1e010fba5
  enableSuperuserAccess: true
  primaryUpdateMethod: switchover

  postgresql:
    shared_preload_libraries:
      - "vectors.so"

  storage:
    storageClass: local-path
    size: 10Gi

  monitoring:
    enablePodMonitor: true

  backup:
    retentionPolicy: "14d"
    barmanObjectStore:
      destinationPath: s3://cnpg-backups
      endpointURL: https://s3.eu-central-003.backblazeb2.com
      wal:
        compression: bzip2
      s3Credentials:
        accessKeyId:
          name: database-backblaze
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: database-backblaze
          key: SECRET_ACCESS_KEY

  bootstrap:
    recovery:
      backup:
        name: daily-backup-20240211000000
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: daily-backup
  namespace: database
spec:
  schedule: "@daily"
  cluster:
    name: app-db
