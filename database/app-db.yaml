apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: app-db
  namespace: database
spec:
  instances: 3

  storage:
    storageClass: local-path
    size: 10Gi

  monitoring:
    enablePodMonitor: true

  backup:
    retentionPolicy: "30d"
    barmanObjectStore:
      destinationPath: s3://app-db-backup/
      endpointURL: http://minio:9000
      wal:
        compression: bzip2
      s3Credentials:
          accessKeyId:
            name: minio-creds
            key: MINIO_ROOT_USER
          secretAccessKey:
            name: minio-creds
            key: MINIO_ROOT_PASSWORD
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: daily-backup
  namespace: database
spec:
  schedule: "@daily"
  cluster:
    name: app-db
