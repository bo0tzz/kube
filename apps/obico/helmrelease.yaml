apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: obico
  namespace: applications
spec:
  interval: 15m
  chart:
    spec:
      chart: app-template
      version: 1.3.2
      sourceRef:
        kind: HelmRepository
        name: bjw-s-charts
        namespace: applications
  values:
    probes:
      liveness:
        enabled: false
      readiness:
        enabled: false
      startup:
        enabled: false
    image:
      repository: ghcr.io/gabe565/obico/web
      tag: sha-72b26dfa6f35800388816c621870664e5501dd19

    env:
      OCTOPRINT_TUNNEL_PORT_RANGE: "0-0"
      SITE_USES_HTTPS: "True"
      SITE_IS_PUBLIC: "False"
      SOCIAL_LOGIN: "False"
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "sqlite:////app/db/db.sqlite3"
      INTERNAL_MEDIA_HOST: "http://obico:3334"
      ML_API_HOST: "http://ml-api:3333"
      ACCOUNT_ALLOW_SIGN_UP: "False"
      WEBPACK_LOADER_ENABLED: "False"

    command:
      [
        "/bin/sh",
        "-c",
        "python manage.py migrate && python manage.py collectstatic -v 2 --noinput && python manage.py runserver --nostatic --noreload 0.0.0.0:3334",
      ]

    persistence:
      config:
        enabled: true
        existingClaim: obico-config
        mountPath: /app/db
      media:
        enabled: true
        existingClaim: obico-media
        mountPath: /app/static_build/media

    service:
      main:
        ports:
          http:
            port: 3334

    ingress:
      main:
        enabled: true
        annotations:
          kubernetes.io/ingress.class: nginx-internal
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - host: &host obico.bo0tzz.me
            paths:
              - path: /
        tls:
          - hosts:
              - *host
            secretName: obico-web-tls

    resources:
      requests:
        cpu: 511m
        memory: 4096M

    sidecars:
      ml-api:
        name: ml-api
        image: ghcr.io/gabe565/obico/ml-api:sha-72b26dfa6f35800388816c621870664e5501dd19
        env:
          FLASK_APP: "server.py"
        command:
          - /bin/bash
          - -c
          - "gunicorn --bind 0.0.0.0:3333 --workers 1 wsgi"
      redis:
        name: redis
        image: redis:7.0-alpine
