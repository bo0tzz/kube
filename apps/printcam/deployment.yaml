apiVersion: apps/v1
kind: Deployment
metadata:
  name: printcam
  namespace: applications
  labels:
    app: printcam
spec:
  selector:
    matchLabels:
      app: printcam
  replicas: 1
  template:
    metadata:
      labels:
        app: printcam
    spec:
      initContainers:
        - name: init
          image: ubuntu
          command: ['sh', '-c', 'echo "Initializing..." > /shared/overlay.txt && mkdir /shared/hls/']
          volumeMounts:
            - name: shared
              mountPath: /shared
      containers:
        - name: ffmpeg
          image: ghcr.io/bo0tzz/ffmpeg-fonts:main
          imagePullPolicy: Always
          args:
            - "-i"
            - "http://octopi/webcam/?action=stream"
            - "-vf"
            - "drawtext=textfile=/shared/overlay.txt:fontcolor=white:fontsize=40:box=1:boxcolor=black@0.5:x=w-tw:y=0"
            - "-f"
            - "hls"
            - "-preset"
            - "superfast"
            - "-c:v"
            - "libx264"
            - "-b:v"
            - "5000k"
            - "-hls_flags"
            - "delete_segments"
            - "/shared/hls/stream.m3u8"
          volumeMounts:
            - name: shared
              mountPath: /shared
        - name: nginx
          image: tiangolo/nginx-rtmp:latest-2022-12-26
          imagePullPolicy: Always
          ports:
            - containerPort: 80
          volumeMounts:
            - name: nginx-config
              mountPath: /etc/nginx
            - name: shared
              mountPath: /shared
      volumes:
        - name: nginx-config
          configMap: 
            name: printcam-config
            items:
              - key: nginx.conf
                path: nginx.conf
        - name: shared
          emptyDir: {}